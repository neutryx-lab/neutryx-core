---
apiVersion: batch/v1
kind: Job
metadata:
  name: neutryx-db-restore
  labels:
    app: neutryx
    component: restore
spec:
  backoffLimit: 1
  template:
    metadata:
      labels:
        app: neutryx
        component: restore
    spec:
      restartPolicy: Never
      serviceAccountName: neutryx-backup
      containers:
        - name: restore
          image: postgres:15-alpine
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e

              if [ -z "$RESTORE_BACKUP_FILE" ]; then
                echo "ERROR: RESTORE_BACKUP_FILE environment variable not set"
                exit 1
              fi

              echo "Starting database restore from ${RESTORE_BACKUP_FILE}"

              # Download backup from cloud storage
              gsutil cp gs://${BACKUP_BUCKET}/database/${RESTORE_BACKUP_FILE} /tmp/restore.sql.gz

              # Verify download
              if [ ! -f /tmp/restore.sql.gz ]; then
                echo "ERROR: Failed to download backup file"
                exit 1
              fi

              # Drop existing connections (optional, requires superuser)
              # psql -h $DB_HOST -U $DB_USER -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$DB_NAME' AND pid <> pg_backend_pid();"

              # Restore database
              echo "Restoring database..."
              gunzip -c /tmp/restore.sql.gz | psql -h $DB_HOST -U $DB_USER -d $DB_NAME

              # Verify restore
              RECORD_COUNT=$(psql -h $DB_HOST -U $DB_USER -d $DB_NAME -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
              echo "Restore completed. Table count: ${RECORD_COUNT}"

              # Clean up
              rm -f /tmp/restore.sql.gz

              echo "Database restore completed successfully"
          env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: neutryx-db-secret
                  key: host
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: neutryx-db-secret
                  key: username
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: neutryx-db-secret
                  key: database
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: neutryx-db-secret
                  key: password
            - name: BACKUP_BUCKET
              value: "neutryx-backups"
            - name: RESTORE_BACKUP_FILE
              value: ""  # Set this to the backup file to restore
          volumeMounts:
            - name: gcp-credentials
              mountPath: /secrets/gcp
              readOnly: true
          resources:
            requests:
              cpu: 1000m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 4Gi
      volumes:
        - name: gcp-credentials
          secret:
            secretName: gcp-storage-credentials
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: neutryx-dr-procedures
  labels:
    app: neutryx
data:
  disaster-recovery-runbook.md: |
    # Neutryx Disaster Recovery Runbook

    ## Recovery Time Objective (RTO): 15 minutes
    ## Recovery Point Objective (RPO): 6 hours

    ## Scenarios and Procedures

    ### 1. Single Region Failure

    **Detection:**
    - Health checks failing across all zones in a region
    - Alerts from monitoring system
    - Global load balancer automatically routes traffic away

    **Automatic Response:**
    - Global load balancer redirects traffic to healthy regions
    - Auto-scaling increases capacity in surviving regions

    **Manual Actions (if needed):**
    ```bash
    # Verify failover
    kubectl get pods -n neutryx --context=region-backup

    # Scale up backup region
    kubectl scale deployment neutryx-api --replicas=20 -n neutryx --context=region-backup
    kubectl scale deployment neutryx-worker --replicas=50 -n neutryx --context=region-backup
    ```

    ### 2. Database Corruption/Loss

    **Recovery Steps:**
    ```bash
    # 1. List available backups
    gsutil ls gs://neutryx-backups/database/ | grep neutryx_backup

    # 2. Choose backup to restore (latest or specific)
    export BACKUP_FILE="neutryx_backup_20240101_000000.sql.gz"

    # 3. Create restore job
    kubectl create -f k8s/disaster-recovery/restore-job.yaml \
      --dry-run=client -o yaml | \
      sed "s|RESTORE_BACKUP_FILE: \"\"|RESTORE_BACKUP_FILE: \"$BACKUP_FILE\"|" | \
      kubectl apply -f -

    # 4. Monitor restore progress
    kubectl logs -f job/neutryx-db-restore -n neutryx

    # 5. Verify data integrity
    kubectl exec -it deployment/neutryx-api -n neutryx -- \
      python -m neutryx.cli verify-database
    ```

    ### 3. Complete Regional Disaster

    **Recovery Steps:**
    ```bash
    # 1. Spin up new region
    terraform apply -var="region=europe-west1" -var="dr_mode=true"

    # 2. Restore from backup
    # Follow database restoration procedure above

    # 3. Update global load balancer
    kubectl apply -f k8s/multi-region/global-load-balancer.yaml

    # 4. Verify traffic routing
    curl -H "X-Region: test" https://api.neutryx.io/health
    ```

    ### 4. Kubernetes Cluster Failure

    **Recovery Steps:**
    ```bash
    # 1. Create new cluster in different zone/region
    gcloud container clusters create neutryx-dr \
      --region=europe-west1 \
      --num-nodes=5 \
      --machine-type=n2-standard-8

    # 2. Deploy Neutryx
    kubectl apply -k k8s/overlays/prod --context=neutryx-dr

    # 3. Restore data
    # Follow restoration procedures

    # 4. Update DNS/load balancer
    # Point traffic to new cluster
    ```

    ## Testing Schedule

    - **Monthly:** Backup restore test in dev environment
    - **Quarterly:** Full DR drill with region failover
    - **Annually:** Complete disaster scenario simulation

    ## Contact Information

    - On-Call Engineer: oncall@neutryx.io
    - Platform Team: platform@neutryx.io
    - Emergency Hotline: +1-XXX-XXX-XXXX

  backup-retention-policy.yaml: |
    retention:
      database:
        hourly: 24    # Keep 24 hourly backups (1 day)
        daily: 30     # Keep 30 daily backups (1 month)
        weekly: 12    # Keep 12 weekly backups (3 months)
        monthly: 12   # Keep 12 monthly backups (1 year)

      state:
        daily: 7      # Keep 7 daily state backups
        weekly: 4     # Keep 4 weekly state backups

      logs:
        days: 90      # Keep logs for 90 days

    cleanup:
      schedule: "0 3 * * 0"  # Weekly on Sunday at 3 AM
      enabled: true
