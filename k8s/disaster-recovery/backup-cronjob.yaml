---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: neutryx-db-backup
  labels:
    app: neutryx
    component: backup
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: neutryx
            component: backup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: neutryx-backup
          containers:
            - name: backup
              image: postgres:15-alpine
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="/backups/neutryx_backup_${TIMESTAMP}.sql.gz"

                  echo "Starting database backup at ${TIMESTAMP}"

                  # Dump database
                  pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME | gzip > $BACKUP_FILE

                  # Upload to cloud storage (GCS example)
                  gsutil cp $BACKUP_FILE gs://${BACKUP_BUCKET}/database/

                  # Verify upload
                  gsutil ls gs://${BACKUP_BUCKET}/database/neutryx_backup_${TIMESTAMP}.sql.gz

                  # Clean old local backups
                  find /backups -name "neutryx_backup_*.sql.gz" -mtime +7 -delete

                  echo "Backup completed successfully"
              env:
                - name: DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: neutryx-db-secret
                      key: host
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: neutryx-db-secret
                      key: username
                - name: DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: neutryx-db-secret
                      key: database
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: neutryx-db-secret
                      key: password
                - name: BACKUP_BUCKET
                  value: "neutryx-backups"
              volumeMounts:
                - name: backups
                  mountPath: /backups
                - name: gcp-credentials
                  mountPath: /secrets/gcp
                  readOnly: true
              resources:
                requests:
                  cpu: 500m
                  memory: 512Mi
                limits:
                  cpu: 1000m
                  memory: 2Gi
          volumes:
            - name: backups
              persistentVolumeClaim:
                claimName: neutryx-backup-pvc
            - name: gcp-credentials
              secret:
                secretName: gcp-storage-credentials
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: neutryx-state-backup
  labels:
    app: neutryx
    component: backup
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: neutryx
            component: backup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: neutryx-backup
          containers:
            - name: state-backup
              image: redis:7-alpine
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)

                  echo "Starting Redis state backup at ${TIMESTAMP}"

                  # Trigger Redis save
                  redis-cli -h neutryx-redis SAVE

                  # Copy RDB file
                  kubectl cp neutryx/neutryx-redis-0:/data/dump.rdb /backups/redis_${TIMESTAMP}.rdb

                  # Upload to cloud storage
                  gsutil cp /backups/redis_${TIMESTAMP}.rdb gs://${BACKUP_BUCKET}/redis/

                  echo "State backup completed"
              env:
                - name: BACKUP_BUCKET
                  value: "neutryx-backups"
              volumeMounts:
                - name: backups
                  mountPath: /backups
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 1Gi
          volumes:
            - name: backups
              persistentVolumeClaim:
                claimName: neutryx-backup-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: neutryx-backup-pvc
  labels:
    app: neutryx
    component: backup
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard
  resources:
    requests:
      storage: 100Gi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: neutryx-backup
  labels:
    app: neutryx
    component: backup
  annotations:
    iam.gke.io/gcp-service-account: neutryx-backup@PROJECT_ID.iam.gserviceaccount.com
