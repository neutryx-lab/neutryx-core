name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          PYTHONPATH=$PWD:$PYTHONPATH pytest src/neutryx/tests \
            -n auto \
            --ignore=src/neutryx/tests/regression \
            --ignore=src/neutryx/tests/performance \
            --ignore=src/neutryx/tests/monte_carlo \
            --ignore=src/neutryx/tests/integration/test_cli.py \
            --ignore=src/neutryx/tests/tools/test_kernel_profiler.py \
            --ignore=src/neutryx/tests/test_calibration.py \
            --ignore=src/neutryx/tests/test_calibration_diagnostics.py \
            --ignore=src/neutryx/tests/test_config_smoke.py \
            --ignore=src/neutryx/tests/test_credit_models.py \
            --ignore=src/neutryx/tests/test_ffi_bindings.py \
            --ignore=src/neutryx/tests/test_ffi_performance.py \
            --ignore=src/neutryx/tests/test_fourier_pricing.py \
            --ignore=src/neutryx/tests/test_pde.py

  regression:
    name: Regression suite
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run regression tests
        run: |
          PYTHONPATH=$PWD:$PYTHONPATH pytest src/neutryx/tests/regression \
            --ignore=src/neutryx/tests/regression/test_monte_carlo_greeks.py \
            --ignore=src/neutryx/tests/regression/test_tree_pricing.py \
            --ignore=src/neutryx/tests/regression/test_portfolio_scenarios.py \
            || [ $? -eq 5 ]

  benchmarks:
    name: Performance benchmarks
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run benchmarks
        run: PYTHONPATH=$PWD:$PYTHONPATH pytest src/neutryx/tests/performance --benchmark-only --benchmark-json=benchmark-results.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-results
          path: benchmark-results.json

  security:
    name: Security and dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Dependency vulnerability scan
        run: |
          # GHSA-wj6h-64fc-37mp: Minerva timing attack on P-256 in python-ecdsa
          # This is a false positive because we use python-jose[cryptography] which uses
          # the cryptography backend, not ecdsa. The ecdsa package is only a transitive
          # dependency and is not used for any cryptographic operations.
          # See: https://github.com/mpdavis/python-jose/issues/341
          pip-audit --ignore-vuln GHSA-wj6h-64fc-37mp

      - name: Static analysis security scan
        run: bandit -r src -ll

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          cyclonedx-py requirements -r requirements.txt -o bom.json
        continue-on-error: true

      - name: Upload SBOM artifact
        if: success() || failure()
        uses: actions/upload-artifact@v5
        with:
          name: cyclonedx-sbom
          path: bom.json

  docs-build:
    name: Documentation build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            docs/requirements.txt

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r docs/requirements.txt

      - name: Validate MkDocs build
        run: mkdocs build --strict
