name: Auto PR on Push
on:
  push:
    branches:
      - "feat/**"
      - "fix/**"
      - "chore/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Extract branch name
        id: vars
        run: |
          ref="${GITHUB_REF#refs/heads/}"
          echo "branch=$ref" >> $GITHUB_OUTPUT

      - name: Create PR if not exists
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = '${{ steps.vars.outputs.branch }}';
            const base = 'main'; // 変えるならここ
            // すでに同じ head の PR があるか検索
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`,
            });
            if (prs.length) {
              core.info(`PR already exists: #${prs[0].number}`);
              return;
            }
            // コミットメッセージや最初の行をタイトル候補に
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch,
              per_page: 1
            });
            const defaultTitle = commits[0]?.commit?.message?.split('\n')[0] || branch;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: defaultTitle,
              head: branch,
              base,
              body: `Automated PR for \`${branch}\`.`,
              draft: true  // 最初はドラフトにしておくと安全
            });
            core.info(`Created PR #${pr.number}`);
